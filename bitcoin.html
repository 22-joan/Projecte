<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Informe Bitcoin</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

  <script>
    if (localStorage.getItem("loggedIn") !== "true") {
      window.location.href = "login.html";
    }
  </script>

  <h1>üí∞ Transacciones Bitcoin en Tiempo Real</h1>

  <div class="nav">
    <a href="index.html">üè† Dashboard</a>
    <a href="informes.html">üìä Informe Google Sheets</a>
    <button id="logoutBtn">Cerrar sesi√≥n</button>
  </div>

  <button id="descargarPDF">üìÑ Descargar informe de transacciones > 1 BTC</button>

  <div class="tabla-container">
    <table id="tabla-bitcoin">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Hash</th>
          <th>Monto (BTC)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p id="estado-bitcoin">‚è≥ Cargando datos...</p>

  <script>
    let transaccionesBTC = [];

    async function cargarTransacciones() {
      const estado = document.getElementById("estado-bitcoin");
      const tablaBody = document.querySelector("#tabla-bitcoin tbody");
      estado.textContent = "‚è≥ Cargando datos...";

      try {
        const res = await fetch("https://blockchain.info/unconfirmed-transactions?format=json");
        const data = await res.json();

        transaccionesBTC = data.txs
          .map(tx => {
            const totalBTC = tx.out.reduce((sum, o) => sum + o.value, 0) / 1e8;
            return { hora: new Date(tx.time * 1000).toLocaleTimeString(), hash: tx.hash, btc: totalBTC };
          })
          .filter(tx => tx.btc > 1);

        const mostrarEnTabla = transaccionesBTC.slice(0, 30);

        tablaBody.innerHTML = "";

        if (mostrarEnTabla.length === 0) {
          tablaBody.innerHTML = "<tr><td colspan='3'>No hay transacciones > 1 BTC.</td></tr>";
        } else {
          mostrarEnTabla.forEach(tx => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${tx.hora}</td><td>${tx.hash}</td><td>${tx.btc.toFixed(4)}</td>`;
            tablaBody.appendChild(tr);
          });
        }

        estado.textContent = "‚úÖ Datos actualizados: " + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        estado.textContent = "‚ùå Error al cargar datos.";
      }
    }

    cargarTransacciones();
    setInterval(cargarTransacciones, 15000);

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedIn");
      window.location.href = "login.html";
    });

    document.getElementById("descargarPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const textoBase = `Informe de transacciones de Bitcoin > 1 BTC

Transacciones detectadas en tiempo real:\n\n`;

      doc.setFontSize(12);
      doc.text(textoBase, 14, 20, { maxWidth: 180 });

      let y = 50;
      const lineHeight = 7;
      const pageHeight = doc.internal.pageSize.height;

      transaccionesBTC.forEach((tx, index) => {
        const linea = `${index + 1}. Hora: ${tx.hora} | Hash: ${tx.hash} | Monto: ${tx.btc.toFixed(4)} BTC`;

        // Dividir el texto si es muy largo para que quepa en el ancho de la p√°gina
        const lines = doc.splitTextToSize(linea, 180);
        const blockHeight = lines.length * lineHeight;

        // Si el bloque no cabe en la p√°gina actual, a√±adir nueva p√°gina
        if (y + blockHeight > pageHeight - 20) {
          doc.addPage();
          y = 20;
        }

        doc.text(lines, 14, y);
        y += blockHeight + 2; // A√±adir un peque√±o margen extra entre transacciones
      });

      doc.save("Informe_Transacciones_Bitcoin.pdf");
    });
  </script>

</body>

</html>
